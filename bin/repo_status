#!/bin/bash

### Show current branch for each of multiple repos

REPONAMES=( control hiera legacy )
REPOCOLORS=( 7 6 208 )
PUPDIR="$HOME/puppet"


die() {
    echo "ERROR: (${BASH_SOURCE[1]} [${BASH_LINENO[0]}] ${FUNCNAME[1]}) $*" 1>&2
    exit 1
}


get_max_length() {
    declare -a ary=($"${!1}")
    for x in "${ary[@]}"; do echo "$x"; done | wc -L
}


pr_hdr() {
    text="$1"
    clr=$2
    len=$3
    printf "\e[30;48;5;${clr}m %${len}s \e[0m" "$text"
}


pr_state() {
    clr=39
    case "$1" in
        clean)
            clr=32
            ;;
        dirty)
            clr=31
            ;;
        * )
            die "unknown state"
            ;;
    esac
    printf "\e[${clr}m ${1}\e[0m"
}


# Get current branch names
branches=()
for repo in "${REPONAMES[@]}"; do
    branches+=( $( git --git-dir "$PUPDIR/$repo/.git" branches \
    | sed -ne 's/^* // p' ) )
done
#for b in "${branches[@]}"; do echo "$b"; done
#exit 1

# Get clean/dirty status
clean_dirty=()
for repo in "${REPONAMES[@]}"; do
    pushd "$PUPDIR/$repo" &>/dev/null
    state=clean
    dirty_count=$( git status --porcelain \
    | grep -E '^( ?[M\?])' \
    | wc -l )
    [[ $dirty_count -gt 0 ]] && state=dirty
    clean_dirty+=( "$state" )
    popd &>/dev/null
done
#for x in "${clean_dirty[@]}"; do echo $x; done
#exit 1

hdr_len=$( get_max_length REPONAMES[@] )
br_len=$( get_max_length branches[@] )
let end="${#REPONAMES[*]}-1"
for i in $(seq 0 $end); do
    repo=${REPONAMES[$i]}
    reponame=$( echo "$repo" | tr [a-z] [A-Z] )
    br_name="${branches[$i]}"
    c=${REPOCOLORS[$i]}
    pr_state "${clean_dirty[$i]}"
    printf "  "
    pr_hdr "$reponame" $c $hdr_len
    printf "  %-${br_len}s" "${br_name}"
#    printf " "
#    pr_state "${clean_dirty[$i]}"
    echo
done
echo

# https://misc.flogisoft.com/bash/tip_colors_and_formatting
